<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audio Sample Generator — Bilingual (VI/EN)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#0f1724;color:#e6eef8;padding:20px}
    .card{background:#0b1220;border-radius:12px;padding:18px;max-width:1000px;margin:12px auto;box-shadow:0 6px 24px rgba(2,6,23,.6)}
    label{display:block;margin-top:10px;font-size:14px;cursor:help}
    label:hover{color:#58a6ff}
    input[type=range]{width:100%}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    button{background:#1f6feb;border:none;padding:10px 14px;border-radius:8px;color:white;cursor:pointer;margin-top:10px;transition:background .2s}
    button:hover{background:#2a7fff}
    button.secondary{background:#334155}
    button.secondary:hover{background:#475569}
    .footer{font-size:13px;color:#9fb0c9;margin-top:8px}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    input[type=number]{width:100%;padding:6px;border-radius:6px;border:1px solid #253341;background:#08101a;color:#e6eef8}
    select{padding:6px;border-radius:6px;border:1px solid #253341;background:#08101a;color:#e6eef8;cursor:pointer}
    .lang{float:right}
    .info-icon{display:inline-block;margin-left:6px;color:#58a6ff;cursor:help;font-size:12px}
    .tooltip-box{position:relative;display:inline-block}
    .tooltip-box:hover .tooltip-text{visibility:visible;opacity:1}
    .tooltip-text{visibility:hidden;opacity:0;position:absolute;z-index:1;background:#1c2938;color:#e6eef8;padding:8px 12px;border-radius:6px;font-size:12px;line-height:1.4;width:280px;bottom:125%;left:50%;margin-left:-140px;transition:opacity .3s;box-shadow:0 4px 12px rgba(0,0,0,.4);border:1px solid #334155}
    .tooltip-text::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:#1c2938 transparent transparent transparent}
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 id="title">Audio Sample Generator</h2>
      <div class="lang">
        <label for="langsel" style="font-size:13px;margin-right:8px;margin-top:0" id="langlabel">Ngôn ngữ</label>
        <select id="langsel" aria-label="Select language">
          <option value="vi">Tiếng Việt</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>

    <p id="desc">Tạo và tải xuống test tone (sine/square/triangle/saw) hoặc noise.</p>

    <div class="controls">
      <div>
        <label id="waveform_label" class="tooltip-box">
          Dạng sóng
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="waveform_tooltip"></span>
        </label>
        <select id="waveform">
          <option value="sine">Sine</option>
          <option value="square">Square</option>
          <option value="triangle">Triangle</option>
          <option value="sawtooth">Sawtooth</option>
          <option value="noise">Noise</option>
        </select>

        <label id="freq_label" class="tooltip-box">
          Tần số (Hz)
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="freq_tooltip"></span>
        </label>
        <div style="display:flex;gap:10px;align-items:center">
          <input type="number" id="freq" value="35" min="1" max="20000" step="1" />
          <input type="range" id="freq_slider" value="35" min="1" max="20000" />
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center"><small id="freq_display">35 Hz</small></div>

        <label id="amp_label" class="tooltip-box">
          Biên độ (0.0 - 1.0)
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="amp_tooltip"></span>
        </label>
        <input type="number" step="0.01" id="amp" value="0.8" min="0" max="1" />

        <label id="dur_label" class="tooltip-box">
          Độ dài (giây)
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="dur_tooltip"></span>
        </label>
        <input type="number" id="duration" value="10" min="0.1" max="600" />
      </div>

      <div>
        <label id="sr_label" class="tooltip-box">
          Tần số mẫu (Hz)
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="sr_tooltip"></span>
        </label>
        <select id="samplerate">
          <option value="8000">8 kHz</option>
          <option value="11025">11.025 kHz</option>
          <option value="16000">16 kHz</option>
          <option value="22050">22.05 kHz</option>
          <option value="32000">32 kHz</option>
          <option value="44100">44.1 kHz</option>
          <option value="48000" selected>48 kHz</option>
          <option value="88200">88.2 kHz</option>
          <option value="96000">96 kHz</option>
          <option value="176400">176.4 kHz</option>
          <option value="192000">192 kHz</option>
        </select>

        <label id="channels_label" class="tooltip-box">
          Kênh
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="channels_tooltip"></span>
        </label>
        <select id="channels">
          <option value="1">Mono</option>
          <option value="2">Stereo</option>
        </select>

        <label id="norm_label" class="tooltip-box">
          Chuẩn hoá trước khi xuất?
          <span class="info-icon">ⓘ</span>
          <span class="tooltip-text" id="norm_tooltip"></span>
        </label>
        <select id="normalize">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>

        <div style="margin-top:10px">
          <button id="play" class="tooltip-box">
            Phát
            <span class="tooltip-text" id="play_tooltip" style="margin-left:-140px"></span>
          </button>
          <button id="stop" class="secondary tooltip-box">
            Dừng
            <span class="tooltip-text" id="stop_tooltip" style="margin-left:-140px"></span>
          </button>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <h3 style="color:#58a6ff;font-size:15px;margin-bottom:8px" id="preset_title">Frequency Presets</h3>
      
      <div style="margin-bottom:12px">
        <strong style="color:#9fb0c9;font-size:13px" id="bass_label">Bass Range</strong><br>
        <button id="preset20" class="secondary tooltip-box">20 Hz <span class="tooltip-text" id="preset20_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset35" class="secondary tooltip-box">35 Hz <span class="tooltip-text" id="preset35_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset40" class="secondary tooltip-box">40 Hz <span class="tooltip-text" id="preset40_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset60" class="secondary tooltip-box">60 Hz <span class="tooltip-text" id="preset60_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset80" class="secondary tooltip-box">80 Hz <span class="tooltip-text" id="preset80_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset100" class="secondary tooltip-box">100 Hz <span class="tooltip-text" id="preset100_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset125" class="secondary tooltip-box">125 Hz <span class="tooltip-text" id="preset125_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset250" class="secondary tooltip-box">250 Hz <span class="tooltip-text" id="preset250_tooltip" style="margin-left:-140px"></span></button>
      </div>
      
      <div style="margin-bottom:12px">
        <strong style="color:#9fb0c9;font-size:13px" id="mid_label">Midrange</strong><br>
        <button id="preset315" class="secondary tooltip-box">315 Hz <span class="tooltip-text" id="preset315_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset500" class="secondary tooltip-box">500 Hz <span class="tooltip-text" id="preset500_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset630" class="secondary tooltip-box">630 Hz <span class="tooltip-text" id="preset630_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset1000" class="secondary tooltip-box">1 kHz <span class="tooltip-text" id="preset1000_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset1250" class="secondary tooltip-box">1.25 kHz <span class="tooltip-text" id="preset1250_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset2000" class="secondary tooltip-box">2 kHz <span class="tooltip-text" id="preset2000_tooltip" style="margin-left:-140px"></span></button>
      </div>
      
      <div style="margin-bottom:12px">
        <strong style="color:#9fb0c9;font-size:13px" id="treble_label">Treble & Air</strong><br>
        <button id="preset2500" class="secondary tooltip-box">2.5 kHz <span class="tooltip-text" id="preset2500_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset4000" class="secondary tooltip-box">4 kHz <span class="tooltip-text" id="preset4000_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset5000" class="secondary tooltip-box">5 kHz <span class="tooltip-text" id="preset5000_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset8000" class="secondary tooltip-box">8 kHz <span class="tooltip-text" id="preset8000_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset10000" class="secondary tooltip-box">10 kHz <span class="tooltip-text" id="preset10000_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset12500" class="secondary tooltip-box">12.5 kHz <span class="tooltip-text" id="preset12500_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset16000" class="secondary tooltip-box">16 kHz <span class="tooltip-text" id="preset16000_tooltip" style="margin-left:-140px"></span></button>
      </div>
      
      <div style="margin-bottom:12px">
        <strong style="color:#9fb0c9;font-size:13px" id="special_label">Special Tests</strong><br>
        <button id="preset_pinknoise" class="secondary tooltip-box">Pink Noise <span class="tooltip-text" id="preset_pinknoise_tooltip" style="margin-left:-140px"></span></button>
        <button id="preset_whitenoise" class="secondary tooltip-box">White Noise <span class="tooltip-text" id="preset_whitenoise_tooltip" style="margin-left:-140px"></span></button>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="download" class="tooltip-box">
        Render & Tải xuống WAV
        <span class="tooltip-text" id="download_tooltip" style="margin-left:-140px"></span>
      </button>
    </div>

    <div class="footer" id="footer">Lưu ý: trình duyệt có thể giới hạn âm lượng.</div>
  </div>

  <script>
    const strings = {
      vi: {
        title: 'Audio Sample Generator',
        desc: 'Tạo và tải xuống test tone hoặc noise.',
        waveform_label: 'Dạng sóng',
        waveform_tooltip: 'Chọn dạng sóng âm thanh',
        freq_label: 'Tần số (Hz)',
        freq_tooltip: 'Độ cao/thấp của âm thanh',
        amp_label: 'Biên độ (0.0 - 1.0)',
        amp_tooltip: 'Âm lượng của tín hiệu',
        dur_label: 'Độ dài (giây)',
        dur_tooltip: 'Thời gian phát',
        sr_label: 'Tần số mẫu (Hz)',
        sr_tooltip: 'Số lần ghi âm mỗi giây',
        channels_label: 'Kênh',
        channels_tooltip: 'Mono hoặc Stereo',
        norm_label: 'Chuẩn hoá?',
        norm_tooltip: 'Tăng biên độ tối đa',
        play: 'Phát',
        play_tooltip: 'Phát âm thanh',
        stop: 'Dừng',
        stop_tooltip: 'Dừng phát',
        download: 'Render & Tải xuống WAV',
        download_tooltip: 'Tạo file WAV',
        preset_title: 'Preset Tần Số',
        bass_label: 'Dải Bass',
        mid_label: 'Dải Mid',
        treble_label: 'Dải Treble',
        special_label: 'Test Đặc Biệt',
        preset20_tooltip: '20Hz - Infrasound, test sub cực mạnh',
        preset35_tooltip: '35Hz - Bass cực sâu, test subwoofer',
        preset40_tooltip: '40Hz - Sub-bass, rạp chiếu phim',
        preset60_tooltip: '60Hz - Bass thấp, EDM, hip-hop',
        preset80_tooltip: '80Hz - Bass punch, kick drum',
        preset100_tooltip: '100Hz - Bass trung, bass guitar',
        preset125_tooltip: '125Hz - Bass warm, acoustic',
        preset250_tooltip: '250Hz - Low-mid, giọng nam',
        preset315_tooltip: '315Hz - Body, độ dày vocal',
        preset500_tooltip: '500Hz - Mid, vocal clarity',
        preset630_tooltip: '630Hz - Vocal fundamental',
        preset1000_tooltip: '1kHz - Reference tone chuẩn',
        preset1250_tooltip: '1.25kHz - Articulation, độ rõ lời',
        preset2000_tooltip: '2kHz - High-mid, tai nhạy nhất',
        preset2500_tooltip: '2.5kHz - Presence peak',
        preset4000_tooltip: '4kHz - Treble thấp, consonant',
        preset5000_tooltip: '5kHz - Sibilance, tiếng s',
        preset8000_tooltip: '8kHz - Treble cao, brilliance',
        preset10000_tooltip: '10kHz - Air, sparkle',
        preset12500_tooltip: '12.5kHz - Upper air, shimmer',
        preset16000_tooltip: '16kHz - Giới hạn trên tai người',
        preset_pinknoise_tooltip: 'Pink Noise - Test cân bằng tần số',
        preset_whitenoise_tooltip: 'White Noise - Burn-in loa',
        footer: 'Lưu ý: trình duyệt có thể giới hạn âm lượng.',
        langlabel: 'Ngôn ngữ'
      },
      en: {
        title: 'Audio Sample Generator',
        desc: 'Generate and download test tones or noise.',
        waveform_label: 'Waveform',
        waveform_tooltip: 'Select audio waveform',
        freq_label: 'Frequency (Hz)',
        freq_tooltip: 'Pitch/tone height',
        amp_label: 'Amplitude (0.0 - 1.0)',
        amp_tooltip: 'Signal volume',
        dur_label: 'Duration (seconds)',
        dur_tooltip: 'Playback time',
        sr_label: 'Sample rate (Hz)',
        sr_tooltip: 'Samples per second',
        channels_label: 'Channel',
        channels_tooltip: 'Mono or Stereo',
        norm_label: 'Normalize?',
        norm_tooltip: 'Boost to max amplitude',
        play: 'Play',
        play_tooltip: 'Play audio',
        stop: 'Stop',
        stop_tooltip: 'Stop playback',
        download: 'Render & Download WAV',
        download_tooltip: 'Generate WAV file',
        preset_title: 'Frequency Presets',
        bass_label: 'Bass Range',
        mid_label: 'Midrange',
        treble_label: 'Treble & Air',
        special_label: 'Special Tests',
        preset20_tooltip: '20Hz - Infrasound, extreme sub test',
        preset35_tooltip: '35Hz - Deep bass, subwoofer test',
        preset40_tooltip: '40Hz - Sub-bass, cinema',
        preset60_tooltip: '60Hz - Low bass, EDM, hip-hop',
        preset80_tooltip: '80Hz - Bass punch, kick drum',
        preset100_tooltip: '100Hz - Mid-bass, bass guitar',
        preset125_tooltip: '125Hz - Bass warmth, acoustic',
        preset250_tooltip: '250Hz - Low-mid, male vocals',
        preset315_tooltip: '315Hz - Body, vocal thickness',
        preset500_tooltip: '500Hz - Mid, vocal clarity',
        preset630_tooltip: '630Hz - Vocal fundamental',
        preset1000_tooltip: '1kHz - Reference tone standard',
        preset1250_tooltip: '1.25kHz - Articulation, clarity',
        preset2000_tooltip: '2kHz - High-mid, most sensitive',
        preset2500_tooltip: '2.5kHz - Presence peak',
        preset4000_tooltip: '4kHz - Lower treble, consonants',
        preset5000_tooltip: '5kHz - Sibilance, s sounds',
        preset8000_tooltip: '8kHz - Upper treble, brilliance',
        preset10000_tooltip: '10kHz - Air, sparkle',
        preset12500_tooltip: '12.5kHz - Upper air, shimmer',
        preset16000_tooltip: '16kHz - Upper hearing limit',
        preset_pinknoise_tooltip: 'Pink Noise - Frequency balance test',
        preset_whitenoise_tooltip: 'White Noise - Speaker burn-in',
        footer: 'Note: browsers may limit output volume.',
        langlabel: 'Language'
      }
    };

    const langSel = document.getElementById('langsel');
    langSel.addEventListener('change', ()=>{ setLang(langSel.value); });

    function setLang(l){
      const s = strings[l];
      document.getElementById('title').innerText = s.title;
      document.getElementById('desc').innerText = s.desc;
      document.getElementById('waveform_label').childNodes[0].textContent = s.waveform_label + ' ';
      document.getElementById('waveform_tooltip').innerText = s.waveform_tooltip;
      document.getElementById('freq_label').childNodes[0].textContent = s.freq_label + ' ';
      document.getElementById('freq_tooltip').innerText = s.freq_tooltip;
      document.getElementById('amp_label').childNodes[0].textContent = s.amp_label + ' ';
      document.getElementById('amp_tooltip').innerText = s.amp_tooltip;
      document.getElementById('dur_label').childNodes[0].textContent = s.dur_label + ' ';
      document.getElementById('dur_tooltip').innerText = s.dur_tooltip;
      document.getElementById('sr_label').childNodes[0].textContent = s.sr_label + ' ';
      document.getElementById('sr_tooltip').innerText = s.sr_tooltip;
      document.getElementById('channels_label').childNodes[0].textContent = s.channels_label + ' ';
      document.getElementById('channels_tooltip').innerText = s.channels_tooltip;
      document.getElementById('norm_label').childNodes[0].textContent = s.norm_label + ' ';
      document.getElementById('norm_tooltip').innerText = s.norm_tooltip;
      document.getElementById('play').childNodes[0].textContent = s.play + ' ';
      document.getElementById('play_tooltip').innerText = s.play_tooltip;
      document.getElementById('stop').childNodes[0].textContent = s.stop + ' ';
      document.getElementById('stop_tooltip').innerText = s.stop_tooltip;
      document.getElementById('download').childNodes[0].textContent = s.download + ' ';
      document.getElementById('download_tooltip').innerText = s.download_tooltip;
      
      document.getElementById('preset_title').innerText = s.preset_title;
      document.getElementById('bass_label').innerText = s.bass_label;
      document.getElementById('mid_label').innerText = s.mid_label;
      document.getElementById('treble_label').innerText = s.treble_label;
      document.getElementById('special_label').innerText = s.special_label;
      
      const presets = ['20', '35', '40', '60', '80', '100', '125', '250', '315', '500', '630', '1000', '1250', '2000', '2500', '4000', '5000', '8000', '10000', '12500', '16000'];
      presets.forEach(p => {
        const el = document.getElementById('preset' + p + '_tooltip');
        if(el && s['preset' + p + '_tooltip']) el.innerText = s['preset' + p + '_tooltip'];
      });
      
      if(document.getElementById('preset_pinknoise_tooltip')) {
        document.getElementById('preset_pinknoise_tooltip').innerText = s.preset_pinknoise_tooltip;
      }
      if(document.getElementById('preset_whitenoise_tooltip')) {
        document.getElementById('preset_whitenoise_tooltip').innerText = s.preset_whitenoise_tooltip;
      }
      
      document.getElementById('footer').innerText = s.footer;
      document.getElementById('langlabel').innerText = s.langlabel;
    }

    setLang(langSel.value);

    const freq = document.getElementById('freq');
    const freqSlider = document.getElementById('freq_slider');
    const freqDisplay = document.getElementById('freq_display');
    
    freq.addEventListener('input', ()=>{ 
      freqSlider.value = freq.value; 
      updateFreqDisplay(freq.value); 
    });
    
    freqSlider.addEventListener('input', ()=>{ 
      freq.value = freqSlider.value; 
      updateFreqDisplay(freqSlider.value); 
    });
    
    function updateFreqDisplay(v){ 
      freqDisplay.innerText = Math.round(v*10)/10 + ' Hz'; 
    }

    let realtimeCtx, osc, gainNode, noiseSource, playing = false;
    const waveformEl = document.getElementById('waveform');
    const ampEl = document.getElementById('amp');
    const durationEl = document.getElementById('duration');
    const srEl = document.getElementById('samplerate');
    const channelsEl = document.getElementById('channels');
    const normalizeEl = document.getElementById('normalize');

    function startRealtime() {
      if (playing) return;
      realtimeCtx = new (window.AudioContext || window.webkitAudioContext)();
      const wave = waveformEl.value;
      const gain = parseFloat(ampEl.value);
      const freqVal = parseFloat(freq.value);

      if (wave === 'noise') {
        const bufferSize = 2 * realtimeCtx.sampleRate;
        const noiseBuffer = realtimeCtx.createBuffer(1, bufferSize, realtimeCtx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) output[i] = (Math.random() * 2 - 1) * gain;
        noiseSource = realtimeCtx.createBufferSource();
        noiseSource.buffer = noiseBuffer;
        const loopGain = realtimeCtx.createGain();
        loopGain.gain.value = 1.0;
        noiseSource.connect(loopGain).connect(realtimeCtx.destination);
        noiseSource.loop = true;
        noiseSource.start();
      } else {
        osc = realtimeCtx.createOscillator();
        osc.type = wave;
        osc.frequency.value = freqVal;
        gainNode = realtimeCtx.createGain();
        gainNode.gain.value = gain;
        osc.connect(gainNode).connect(realtimeCtx.destination);
        osc.start();
      }
      playing = true;
    }

    function stopRealtime() {
      if (!playing) return;
      try {
        if (osc) { osc.stop(); osc.disconnect(); osc = null; }
        if (noiseSource) { noiseSource.stop(); noiseSource.disconnect(); noiseSource = null; }
        if (gainNode) { gainNode.disconnect(); gainNode = null; }
        if (realtimeCtx) { realtimeCtx.close(); realtimeCtx = null; }
      } catch(e){console.warn(e)}
      playing = false;
    }

    document.getElementById('play').addEventListener('click', startRealtime);
    document.getElementById('stop').addEventListener('click', stopRealtime);

    const presetConfigs = {
      preset20: [20, 0.9], preset35: [35, 0.9], preset40: [40, 0.9], preset60: [60, 0.8],
      preset80: [80, 0.8], preset100: [100, 0.8], preset125: [125, 0.8], preset250: [250, 0.7],
      preset315: [315, 0.7], preset500: [500, 0.7], preset630: [630, 0.7], preset1000: [1000, 0.7],
      preset1250: [1250, 0.7], preset2000: [2000, 0.6], preset2500: [2500, 0.6], preset4000: [4000, 0.6],
      preset5000: [5000, 0.6], preset8000: [8000, 0.5], preset10000: [10000, 0.5], preset12500: [12500, 0.5],
      preset16000: [16000, 0.5]
    };

    Object.keys(presetConfigs).forEach(id => {
      document.getElementById(id).addEventListener('click', ()=>{
        const [f, a] = presetConfigs[id];
        waveformEl.value = 'sine';
        freq.value = f;
        freqSlider.value = f;
        updateFreqDisplay(f);
        ampEl.value = a;
        durationEl.value = 10;
        srEl.value = 48000;
        channelsEl.value = 1;
      });
    });

    document.getElementById('preset_pinknoise').addEventListener('click', ()=>{ 
      waveformEl.value='noise'; ampEl.value='0.7'; durationEl.value='30'; srEl.value='48000'; channelsEl.value='2'; 
    });
    
    document.getElementById('preset_whitenoise').addEventListener('click', ()=>{ 
      waveformEl.value='noise'; ampEl.value='0.7'; durationEl.value='30'; srEl.value='48000'; channelsEl.value='2'; 
    });

    document.getElementById('download').addEventListener('click', async ()=>{
      const wave = waveformEl.value;
      const freqVal = parseFloat(freq.value);
      const amp = parseFloat(ampEl.value);
      const duration = parseFloat(durationEl.value);
      const sampleRate = parseInt(srEl.value,10);
      const channels = parseInt(channelsEl.value,10);
      const doNormalize = normalizeEl.value === 'true';

      const totalSamples = Math.floor(sampleRate * duration);
      const buffers = [];
      for (let c=0;c<channels;c++) buffers.push(new Float32Array(totalSamples));
      for (let i=0;i<totalSamples;i++){
        const t = i / sampleRate;
        let v = 0;
        if (wave === 'noise') v = (Math.random()*2 -1) * amp;
        else {
          const phase = 2 * Math.PI * freqVal * t;
          switch(wave){
            case 'sine': v = Math.sin(phase) * amp; break;
            case 'square': v = (Math.sin(phase) >= 0 ? 1 : -1) * amp; break;
            case 'triangle': v = (2/Math.PI) * Math.asin(Math.sin(phase)) * amp; break;
            case 'sawtooth': v = (2/Math.PI) * (freqVal * Math.PI * (t % (1/freqVal)) - (Math.PI/2)) * amp; break;
            default: v = Math.sin(phase) * amp;
          }
        }
        for (let c=0;c<channels;c++) buffers[c][i] = v;
      }

      const fakeBuffer = { numberOfChannels: channels, length: totalSamples, sampleRate: sampleRate, getChannelData: (ch)=>buffers[ch] };
      const wavBlob = bufferToWavBlob(fakeBuffer, doNormalize);
      triggerDownload(wavBlob, 'test-tone-' + wave + '-' + freqVal + 'Hz-' + duration + 's.wav');
    });

    function bufferToWavBlob(audioBuffer, normalize){
      const numChannels = audioBuffer.numberOfChannels;
      const sampleRate = audioBuffer.sampleRate;
      const length = audioBuffer.length;
      const samples = new Float32Array(length * numChannels);
      for (let ch=0; ch<numChannels; ch++){
        const data = audioBuffer.getChannelData(ch);
        for (let i=0;i<length;i++) samples[i * numChannels + ch] = data[i];
      }
      if (normalize){ 
        let max = 0; 
        for (let i=0;i<samples.length;i++){ 
          const a = Math.abs(samples[i]); 
          if (a>max) max=a; 
        } 
        if (max>0){ 
          const norm = 1.0/max; 
          for (let i=0;i<samples.length;i++) samples[i]*=norm; 
        } 
      }
      const buffer = new ArrayBuffer(44 + samples.length * 2);
      const view = new DataView(buffer);
      writeString(view, 0, 'RIFF'); 
      view.setUint32(4, 36 + samples.length * 2, true); 
      writeString(view, 8, 'WAVE'); 
      writeString(view, 12, 'fmt '); 
      view.setUint32(16, 16, true); 
      view.setUint16(20, 1, true); 
      view.setUint16(22, numChannels, true); 
      view.setUint32(24, sampleRate, true); 
      view.setUint32(28, sampleRate * numChannels * 2, true); 
      view.setUint16(32, numChannels * 2, true); 
      view.setUint16(34, 16, true); 
      writeString(view, 36, 'data'); 
      view.setUint32(40, samples.length * 2, true);
      let offset = 44; 
      for (let i = 0; i < samples.length; i++, offset += 2) { 
        let s = Math.max(-1, Math.min(1, samples[i])); 
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true); 
      }
      return new Blob([view], { type: 'audio/wav' });
      
      function writeString(view, offset, string) { 
        for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); 
      }
    }

    function triggerDownload(blob, filename){ 
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.style.display='none'; 
      a.href = url; 
      a.download = filename; 
      document.body.appendChild(a); 
      a.click(); 
      setTimeout(()=>{ 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
      }, 1500); 
    }

  </script>
</body>
</html>
